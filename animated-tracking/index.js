"use strict";var __assign=this&&this.__assign||function(){return(__assign=Object.assign||function(t){for(var n,e=1,i=arguments.length;e<i;e++)for(var o in n=arguments[e])Object.prototype.hasOwnProperty.call(n,o)&&(t[o]=n[o]);return t}).apply(this,arguments)},__spreadArrays=this&&this.__spreadArrays||function(){for(var t=0,n=0,e=arguments.length;n<e;n++)t+=arguments[n].length;var i=Array(t),o=0;for(n=0;n<e;n++)for(var r=arguments[n],s=0,a=r.length;s<a;s++,o++)i[o]=r[s];return i};Object.defineProperty(exports,"__esModule",{value:!0});var error_omm_1=require("./common/error.omm"),is_1=require("./common/is"),DEFAULT_AMOUNT_PART_OF_LINES=5,DEFAULT_MIN_DINSTANCE_CHANGE_RATE=5.5,DEFAULT_VELOCITY_TIMEOUT=6e4,DEFAULT_ANIMATE_TIME=50,noOpt=function(){console.warn("NO_OPT")};function coord(t,n){return{lat:t,lng:n}}function angle(t,n){return 180*Math.atan2(n.lng-t.lng,n.lat-t.lat)/Math.PI}function deg2rad(t){return t*(Math.PI/180)}function distance(t,n){var e=t.lat,i=t.lat,o=n.lat,r=n.lat,s=deg2rad(o-e),a=deg2rad(r-i),u=Math.sin(s/2)*Math.sin(s/2)+Math.cos(deg2rad(e))*Math.cos(deg2rad(o))*Math.sin(a/2)*Math.sin(a/2);return 6371*(2*Math.atan2(Math.sqrt(u),Math.sqrt(1-u)))}function color(t,n,e){return""+t+Math.floor(255/(n-e+1)).toString(16)}function TVelocity(t,n){var e;return function(){e&&(clearTimeout(e),e=null),e=setTimeout(function(){return t()},n||DEFAULT_VELOCITY_TIMEOUT)}}var PointQueue=function(){function t(t){this.useIndex=0,this.isPassedActiveIndex=!1,this.partOfLine=DEFAULT_AMOUNT_PART_OF_LINES,this.points=[],this.partOfLine=t}return t.prototype.push=function(t){this.points.push(t)},t.prototype.isCurrent=function(){return this.points.length-1>=this.useIndex},t.prototype.isNext=function(){return this.points.length-1>this.useIndex},t.prototype.getCurrent=function(){return this.isCurrent()?this.points[this.useIndex]:null},t.prototype.getNext=function(){return this.isNext()?this.points[this.useIndex+1]:null},t.prototype.getLast=function(){return this.points.length<=0?null:this.points[this.points.length-1]},t.prototype.dinstToNext=function(){if(!this.isNext())return null;var t=this.getCurrent();return t?distance(t,this.points[this.useIndex+1]):null},t.prototype.angleToNext=function(){if(!this.isNext())return null;var t=this.getCurrent();return t?angle(t,this.points[this.useIndex+1]):null},t.prototype.setIsPassedActiveIndex=function(t){return this.isPassedActiveIndex=t,this},t.prototype.ejectFromHeadIfExceedSize=function(){return this.points.length>this.partOfLine&&(this.points.splice(0,1),this.useIndex--),this},t.prototype.next=function(){!this.isPassedActiveIndex&&this.isNext()&&this.useIndex++},t}(),Line=function(){function t(){this.color="",this.points=[]}return t.new=function(){return new t},t.prototype.setColor=function(t){return this.color=t,this},t.prototype.getColor=function(){return this.color},t.prototype.getLast=function(){var t=this.points.length;return t?this.points[t-1]:null},t.prototype.getLine=function(){return this.points},t.prototype.pushPoint=function(t){this.points.push(t)},t}();Object.freeze(Line);var Path=function(){function t(t,n,e,i,o){this.baseColor="",this.lines={},this.onRemoveLine=noOpt,this.onJoinLine=noOpt,this.onPushPoint=noOpt,this.partOfLine=t,this.baseColor=n,this.onRemoveLine=e,this.onJoinLine=i,this.onPushPoint=o}return t.prototype.size=function(){return Object.keys(this.lines).length},t.prototype.getLinesByArray=function(){return Object.values(this.lines)},t.prototype.reorganize=function(){var t=this;if(this.size()<this.partOfLine)Object.values(this.lines).forEach(function(n,e){n.setColor(color(t.baseColor,t.partOfLine,e))});else{delete this.lines[1],this.onRemoveLine(0,1);var n={};Object.values(this.lines).forEach(function(e,i){n[i+1]=e,e.setColor(color(t.baseColor,t.partOfLine,i))}),this.lines=n}},t.prototype.createNewLineAndThanReorganize=function(){this.reorganize();var t=this.size()+1,n=Line.new().setColor(color(this.baseColor,this.partOfLine,t));this.lines[t]=n;var e=this.getLinesByArray();return this.onJoinLine(n.getColor(),n,e),n},t.prototype.pushPoint=function(t){var n=this.size();this.lines[n].pushPoint(t);var e=this.getLinesByArray();this.onPushPoint(t,this.lines[n],e)},t}();Object.freeze(Path);var PointAnimate=function(){function t(t,n,e,i,o){this.handeChangeStatus=noOpt,this.handleLocationChange=noOpt,this.tVelocity=noOpt,this.currentPoint={},this.isRunning=!1,this.timeout=null,this.pointsQueue=t,this.path=n,this.tVelocity=e,this.handleLocationChange=i,this.handeChangeStatus=o}return t.prototype.clearTimeout=function(){clearTimeout(this.timeout),this.timeout=null},t.prototype.setStartStatus=function(){this.isRunning=!0},t.prototype.setStopStatus=function(){this.isRunning=!1},t.prototype.run=function(){var t=this;if(!this.isRunning){this.tVelocity(),this.setStartStatus();var n=this.pointsQueue,e=n.getCurrent(),i=n.getNext();if(e)if(this.handleLocationChange(e,0,!1),i){var o=n.angleToNext();this.handeChangeStatus(o||0,!0),this.path.createNewLineAndThanReorganize();var r=(i.lat-e.lat)/DEFAULT_ANIMATE_TIME,s=(i.lng-e.lng)/DEFAULT_ANIMATE_TIME,a=0,u=function(){var i=coord(e.lat+r*a,e.lng+s*a);t.handleLocationChange(i,o,!0),t.path.pushPoint(i),a<DEFAULT_ANIMATE_TIME?(a+=1,t.timeout=setTimeout(function(){return u()},50)):(t.clearTimeout(),t.setStopStatus(),n.setIsPassedActiveIndex(!1).ejectFromHeadIfExceedSize().next(),t.run())};u()}else this.setStopStatus();else this.setStopStatus()}},t.prototype.getPoint=function(){return this.currentPoint},t.prototype.addPoint=function(t){var n,e;try{var i=this.pointsQueue.getLast(),o=i?distance(i,t):null;if(null!=o&&((null===(n=i)||void 0===n?void 0:n.lat)==t.lat&&(null===(e=i)||void 0===e?void 0:e.lng)===t.lng||100*o<=DEFAULT_MIN_DINSTANCE_CHANGE_RATE))return"NOT OUT OF DISTANCE RATE "+i+", "+t+", dinstance="+o+"m";this.pointsQueue.push(t),this.run(),this.tVelocity()}catch(t){error_omm_1.ErrorOMM.withPrev("SOME THING WENT WRONG WHEN ADDING NEW POINT").printStack().throw()}},t.prototype.unmount=function(){this.clearTimeout()},t}(),defaultOption={color:"",velocityTimeout:DEFAULT_VELOCITY_TIMEOUT,minDistanceChangeRate:DEFAULT_MIN_DINSTANCE_CHANGE_RATE,partOfLine:DEFAULT_AMOUNT_PART_OF_LINES};function handler(){return{handeChangeStatus:function(t,n){},handleChangeLocation:function(t,n,e){},onRemoveLine:function(t,n){},onJoinLine:function(t,n,e){},onPushPoint:function(t,n,e){}}}function factoryAnimatedTracking(t){try{is_1.IsGreatThanNil(t.velocityTimeout)||error_omm_1.ErrorOMM.new("velocityTimeout must be great than 0").throw(),is_1.IsGreatThanNil(t.minDistanceChangeRate)||error_omm_1.ErrorOMM.new("minDistanceChangeRate must be great than 0").throw(),is_1.IsGreatThanNil(t.partOfLine)||error_omm_1.ErrorOMM.new("partOfLine must be great than 0").throw();var n=__assign(__assign({},defaultOption),t),e=handler(),i=function(t){for(var n,i=[],o=1;o<arguments.length;o++)i[o-1]=arguments[o];try{e[t]&&(n=e[t]).call.apply(n,__spreadArrays([null],i))}catch(t){error_omm_1.ErrorOMM.withPrev("CALLBACK COULD NOT INVOKED")}},o=function(t){return JSON.parse(JSON.stringify(t))},r=function(t,n){return i("handeChangeStatus",t,n)},s=TVelocity(function(){return r(0,!1)},n.velocityTimeout),a=new PointQueue(n.partOfLine),u=new Path(t.partOfLine,n.color||"",function(t,n){return i("onRemoveLine",t,n)},function(t,n,e){return i("onJoinLine",t,o(n),o(e))},function(t,n,e){return i("onPushPoint",t,o(n),o(e))}),h=new PointAnimate(a,u,s,function(t,n,e){return i("handleChangeLocation",t,n,e)},r);return{handler:e,pushCoord:function(t){return h.addPoint(t)}}}catch(t){error_omm_1.ErrorOMM.withPrev("COUL NOT INITIALIZED").printStack().throw()}return{}}Object.freeze(handler),exports.factoryAnimatedTracking=factoryAnimatedTracking,Object.freeze(factoryAnimatedTracking);