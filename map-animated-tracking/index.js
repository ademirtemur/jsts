"use strict";var __assign=this&&this.__assign||function(){return(__assign=Object.assign||function(t){for(var e,n=1,i=arguments.length;n<i;n++)for(var o in e=arguments[n])Object.prototype.hasOwnProperty.call(e,o)&&(t[o]=e[o]);return t}).apply(this,arguments)},__spreadArrays=this&&this.__spreadArrays||function(){for(var t=0,e=0,n=arguments.length;e<n;e++)t+=arguments[e].length;var i=Array(t),o=0;for(e=0;e<n;e++)for(var r=arguments[e],s=0,a=r.length;s<a;s++,o++)i[o]=r[s];return i};Object.defineProperty(exports,"__esModule",{value:!0});var MOVEMENT_TYPES,error_omm_1=require("./common/error.omm"),is_1=require("./common/is"),DEFAULT_AMOUNT_PART_OF_LINES=5,DEFAULT_MIN_DINSTANCE_CHANGE_RATE=5.5,DEFAULT_VELOCITY_TIMEOUT=6e4,DEFAULT_ANIMATE_TIME=50;!function(t){t[t.MOVING=1]="MOVING",t[t.SHORT_HALT=2]="SHORT_HALT",t[t.LONG_HALT=3]="LONG_HALT"}(MOVEMENT_TYPES=exports.MOVEMENT_TYPES||(exports.MOVEMENT_TYPES={})),Object.freeze(MOVEMENT_TYPES);var noOpt=function(){console.warn("NO_OPT")};function coord(t,e){return{lat:t,lng:e}}function angle(t,e){return 180*Math.atan2(e.lng-t.lng,e.lat-t.lat)/Math.PI}function deg2rad(t){return t*(Math.PI/180)}function distance(t,e){var n=t.lat,i=t.lat,o=e.lat,r=e.lat,s=deg2rad(o-n),a=deg2rad(r-i),u=Math.sin(s/2)*Math.sin(s/2)+Math.cos(deg2rad(n))*Math.cos(deg2rad(o))*Math.sin(a/2)*Math.sin(a/2);return 6371*(2*Math.atan2(Math.sqrt(u),Math.sqrt(1-u)))}function color(t,e,n){return""+t+Math.floor(255/(e-n+1)).toString(16)}function TVelocity(t,e){var n;return function(){n&&(clearTimeout(n),n=null),n=setTimeout(function(){return t()},e||DEFAULT_VELOCITY_TIMEOUT)}}Object.freeze(noOpt),Object.freeze(coord),Object.freeze(angle),Object.freeze(deg2rad),Object.freeze(distance),Object.freeze(color),Object.freeze(TVelocity);var PointQueue=function(){function t(t){this.useIndex=0,this.isPassedActiveIndex=!1,this.partOfLine=DEFAULT_AMOUNT_PART_OF_LINES,this.points=[],this.partOfLine=t}return t.prototype.push=function(t){this.points.push(t)},t.prototype.isCurrent=function(){return this.points.length-1>=this.useIndex},t.prototype.isNext=function(){return this.points.length-1>this.useIndex},t.prototype.getCurrent=function(){return this.isCurrent()?this.points[this.useIndex]:null},t.prototype.getNext=function(){return this.isNext()?this.points[this.useIndex+1]:null},t.prototype.getLast=function(){return this.points.length<=0?null:this.points[this.points.length-1]},t.prototype.dinstToNext=function(){if(!this.isNext())return null;var t=this.getCurrent();return t?distance(t,this.points[this.useIndex+1]):null},t.prototype.angleToNext=function(){if(!this.isNext())return null;var t=this.getCurrent();return t?angle(t,this.points[this.useIndex+1]):null},t.prototype.setIsPassedActiveIndex=function(t){return this.isPassedActiveIndex=t,this},t.prototype.ejectFromHeadIfExceedSize=function(){return this.points.length>this.partOfLine&&(this.points.splice(0,1),this.useIndex--),this},t.prototype.next=function(){!this.isPassedActiveIndex&&this.isNext()&&this.useIndex++},t}();Object.freeze(PointQueue);var Line=function(){function t(){this.color="",this.points=[]}return t.new=function(){return new t},t.prototype.setColor=function(t){return this.color=t,this},t.prototype.getColor=function(){return this.color},t.prototype.getLast=function(){var t=this.points.length;return t?this.points[t-1]:null},t.prototype.getLine=function(){return this.points},t.prototype.pushPoint=function(t){this.points.push(t)},t}();Object.freeze(Line);var Path=function(){function t(t,e,n,i,o){this.baseColor="",this.lines={},this.onRemoveLine=noOpt,this.onJoinLine=noOpt,this.onPushPoint=noOpt,this.partOfLine=t,this.baseColor=e,this.onRemoveLine=n,this.onJoinLine=i,this.onPushPoint=o}return t.prototype.size=function(){return Object.keys(this.lines).length},t.prototype.getLinesByArray=function(){return Object.values(this.lines)},t.prototype.reorganize=function(){var t=this;if(this.size()<this.partOfLine)Object.values(this.lines).forEach(function(e,n){e.setColor(color(t.baseColor,t.partOfLine,n))});else{delete this.lines[1],this.onRemoveLine(0,1);var e={};Object.values(this.lines).forEach(function(n,i){e[i+1]=n,n.setColor(color(t.baseColor,t.partOfLine,i))}),this.lines=e}},t.prototype.createNewLineAndThanReorganize=function(){this.reorganize();var t=this.size()+1,e=Line.new().setColor(color(this.baseColor,this.partOfLine,t));this.lines[t]=e;var n=this.getLinesByArray();return this.onJoinLine(e.getColor(),e,n),e},t.prototype.pushPoint=function(t){var e=this.size();this.lines[e].pushPoint(t);var n=this.getLinesByArray();this.onPushPoint(t,this.lines[e],n)},t}();Object.freeze(Path);var PointAnimate=function(){function t(t,e,n,i,o,r){this.handeChangeStatus=noOpt,this.handleLocationChange=noOpt,this.tVelocity=noOpt,this.tVelocityLong=noOpt,this.currentPoint={},this.isRunning=!1,this.timeout=null,this.pointsQueue=t,this.path=e,this.tVelocity=n,this.handleLocationChange=i,this.handeChangeStatus=o,this.tVelocityLong=r}return t.prototype.clearTimeout=function(){clearTimeout(this.timeout),this.timeout=null},t.prototype.setStartStatus=function(){this.isRunning=!0},t.prototype.setStopStatus=function(){this.isRunning=!1},t.prototype.callVelocities=function(){this.tVelocity(),this.tVelocityLong&&this.tVelocityLong()},t.prototype.run=function(){var t=this;if(!this.isRunning){this.callVelocities(),this.setStartStatus();var e=this.pointsQueue,n=e.getCurrent(),i=e.getNext();if(n)if(this.handleLocationChange(n,0,!1),i){var o=e.angleToNext();this.handeChangeStatus(o||0,MOVEMENT_TYPES.MOVING),this.path.createNewLineAndThanReorganize();var r=(i.lat-n.lat)/DEFAULT_ANIMATE_TIME,s=(i.lng-n.lng)/DEFAULT_ANIMATE_TIME,a=0,u=function(){var i=coord(n.lat+r*a,n.lng+s*a);t.handleLocationChange(i,o,!0),t.path.pushPoint(i),a<DEFAULT_ANIMATE_TIME?(a+=1,t.timeout=setTimeout(function(){return u()},50)):(t.clearTimeout(),t.setStopStatus(),e.setIsPassedActiveIndex(!1).ejectFromHeadIfExceedSize().next(),t.run())};u()}else this.setStopStatus();else this.setStopStatus()}},t.prototype.getPoint=function(){return this.currentPoint},t.prototype.addPoint=function(t){var e,n;try{var i=this.pointsQueue.getLast(),o=i?distance(i,t):null;if(null!=o&&((null===(e=i)||void 0===e?void 0:e.lat)==t.lat&&(null===(n=i)||void 0===n?void 0:n.lng)===t.lng||100*o<=DEFAULT_MIN_DINSTANCE_CHANGE_RATE))return"NOT OUT OF DISTANCE RATE "+i+", "+t+", dinstance="+o+"m";this.pointsQueue.push(t),this.run(),this.callVelocities()}catch(t){error_omm_1.ErrorOMM.withPrev("SOME THING WENT WRONG WHEN ADDING NEW POINT").printStack().throw()}},t.prototype.unmount=function(){this.clearTimeout()},t}();Object.freeze(PointAnimate);var defaultOption={color:"",velocityTimeout:DEFAULT_VELOCITY_TIMEOUT,velocityLongTimeout:3*DEFAULT_VELOCITY_TIMEOUT,minDistanceChangeRate:DEFAULT_MIN_DINSTANCE_CHANGE_RATE,partOfLine:DEFAULT_AMOUNT_PART_OF_LINES};function handler(){return{handeChangeStatus:function(t,e){},handleChangeLocation:function(t,e,n){},onRemoveLine:function(t,e){},onJoinLine:function(t,e,n){},onPushPoint:function(t,e,n){}}}function factoryAnimatedTracking(t){try{is_1.IsGreatThanNil(t.velocityTimeout)||error_omm_1.ErrorOMM.new("velocityTimeout must be great than 0").throw(),is_1.IsGreatThanNil(t.minDistanceChangeRate)||error_omm_1.ErrorOMM.new("minDistanceChangeRate must be great than 0").throw(),is_1.IsGreatThanNil(t.partOfLine)||error_omm_1.ErrorOMM.new("partOfLine must be great than 0").throw(),t.velocityLongTimeout&&!is_1.IsGreatThanNil(t.velocityLongTimeout)&&error_omm_1.ErrorOMM.new("velocityLongTimeout must be great than 0").throw();var e,n,i,o=__assign(__assign({},defaultOption),t),r=handler(),s=function(t){for(var e,n=[],i=1;i<arguments.length;i++)n[i-1]=arguments[i];try{r[t]&&(e=r[t]).call.apply(e,__spreadArrays([null],n))}catch(t){error_omm_1.ErrorOMM.withPrev("CALLBACK COULD NOT INVOKED")}},a=function(t){return JSON.parse(JSON.stringify(t))},u=noOpt,h=new PointQueue(o.partOfLine);t.velocityLongTimeout&&(i=TVelocity(function(){c(0,MOVEMENT_TYPES.LONG_HALT),u()},o.velocityLongTimeout));var c=function(t,e){return s("handeChangeStatus",t,e)},l=function(t,e,n){return s("handleChangeLocation",t,e,n)},p=function(t,e){return s("onRemoveLine",t,e)},f=function(t,e,n){return s("onJoinLine",t,a(e),a(n))},T=function(t,e,n){return s("onPushPoint",t,a(e),a(n))},O=TVelocity(function(){return c(0,MOVEMENT_TYPES.SHORT_HALT)},o.velocityTimeout);(u=function(){e=new Path(o.partOfLine,o.color||"",p,f,T),n=new PointAnimate(h,e,O,l,c,i)})();return{handler:r,pushCoord:function(t){var e;return null===(e=n)||void 0===e?void 0:e.addPoint(t)},destroy:function(){var t;return null===(t=n)||void 0===t?void 0:t.unmount()}}}catch(t){error_omm_1.ErrorOMM.withPrev("COUL NOT INITIALIZED").printStack().throw()}return{}}Object.freeze(defaultOption),Object.freeze(handler),exports.factoryAnimatedTracking=factoryAnimatedTracking,Object.freeze(factoryAnimatedTracking);
