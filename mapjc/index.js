"use strict";var __assign=this&&this.__assign||function(){return(__assign=Object.assign||function(r){for(var e,t=1,o=arguments.length;t<o;t++)for(var n in e=arguments[t])Object.prototype.hasOwnProperty.call(e,n)&&(r[n]=e[n]);return r}).apply(this,arguments)};Object.defineProperty(exports,"__esModule",{value:!0});var OMM_PROP_TYPES,SPECIAL_KEY,error_omm_1=require("./common/error.omm"),is_1=require("./common/is"),uuid_1=require("./common/uuid");function keyModel(r){return r.prototype[SPECIAL_KEY.OMM_MJC]}function nameModel(r){return r.name}function checkEnum(r){if(!is_1.IsObject(r)&&"Object"!==r.name)return!1;var e=Object.values(r).map(function(r){return typeof r}),r=e.filter(function(r){return Boolean("string"===r||"number"===r)});return Boolean(e.length===r.length).valueOf()}function shildEnum(r){if(!checkEnum(r))throw error_omm_1.ErrorOMM.new("Warninng enum model ‘"+Object.values(r)+"‘")}function _propOmmType(r){if(is_1.IsObject(r))return OMM_PROP_TYPES.ENUM;r=new r;return r instanceof Number?OMM_PROP_TYPES.NUMBER:r instanceof String?OMM_PROP_TYPES.STRING:r instanceof Boolean?OMM_PROP_TYPES.BOOLEAN:r instanceof Date?OMM_PROP_TYPES.DATE:OMM_PROP_TYPES.MODEL}!function(r){r.NUMBER="NUMBER",r.STRING="STRING",r.BOOLEAN="BOOLEAN",r.DATE="DATE",r.MODEL="MODEL",r.ENUM="ENUM"}(OMM_PROP_TYPES=OMM_PROP_TYPES||{}),(SPECIAL_KEY=SPECIAL_KEY||{}).OMM_MJC="__OMM__MJC__";var ModelPropOption=function(){function r(){}return r.new=function(){return new r},r.prototype.getPropType=function(){return this.propType},r.prototype.getIsOptional=function(){return Boolean(this.isOptional)},r.prototype.getIsArray=function(){return Boolean(this.isArray)},r.prototype.getFrom=function(){return this.from},r.prototype.isPropTypeEnum=function(){return Boolean(this.propType.constructor)},r.prototype.setPropType=function(r){return this.propType=r,this},r.prototype.setIsOptional=function(r){return this.isOptional=r,this},r.prototype.setIsArray=function(r){return this.isArray=r,this},r.prototype.setFrom=function(r){return this.from=r,this},r}();Object.freeze(ModelPropOption);var ModelStore=function(){function r(){this.__options={}}return r.prototype.setIsConfirmed=function(r){return this._isConfirmed=r,this},r.prototype.setModel=function(r){return this.__model=r,this},r.prototype.setOnePropOption=function(r,e){return this.__options[r]=e,this},r.prototype.getIsConfirmed=function(){return Boolean(this._isConfirmed)},r.prototype.createModelInstance=function(){return new this.__model},r.prototype.getOptionsKeys=function(){return Object.keys(this.__options)},r.prototype.getOptionByPropName=function(r){return this.__options[r]},r}();Object.freeze(ModelStore);var storeInstance=function(){var n={};function i(r){return"-//{"+nameModel(r)+"}//"}function s(r){var e;e=r,t=uuid_1.UUID()+i(e),Object.defineProperty(e.prototype,SPECIAL_KEY.OMM_MJC,{value:t,writable:!1,configurable:!1,enumerable:!1});var t=(new ModelStore).setModel(r);n[keyModel(r)]=t}function O(r,e,t){throw new error_omm_1.ErrorOMM("‘"+r+"‘ expected ‘"+e+"‘ value but value is ‘"+t+"‘")}function l(s,u){var c,M,r=keyModel(s),e=nameModel(s);if(!Boolean(n[r]))throw new error_omm_1.ErrorOMM("Model is not defined...");var p=n[r];if(!p.getIsConfirmed())throw new error_omm_1.ErrorOMM("Model(‘"+e+"‘) has not defined as '@Model'");var a=p.createModelInstance();function _(r,e,t,o){var n,i,s;if(n=r,i=t,s=o,(r=e)!==OMM_PROP_TYPES.NUMBER||is_1.IsNumber(i)||O(n,OMM_PROP_TYPES.NUMBER,i),r!==OMM_PROP_TYPES.STRING||is_1.IsString(i)||O(n,OMM_PROP_TYPES.STRING,i),r!==OMM_PROP_TYPES.BOOLEAN||is_1.IsBoolean(i)||O(n,OMM_PROP_TYPES.BOOLEAN,i),r!==OMM_PROP_TYPES.DATE||is_1.IsDate(i)||O(n,OMM_PROP_TYPES.DATE,i),r===OMM_PROP_TYPES.ENUM&&s&&!Object.values(s||{}).find(function(r){return r===i})&&(shildEnum(s),O(n,OMM_PROP_TYPES.ENUM+"("+Object.values(s||{})+")",i)),e===OMM_PROP_TYPES.ENUM)return t;t=new o(t);return e===OMM_PROP_TYPES.DATE?t:t.valueOf()}for(var t=0,o=p.getOptionsKeys();t<o.length;t++)!function(e){try{var r=p.getOptionByPropName(e),t=r.getPropType(),o=""===t.name?t():t,n=_propOmmType(o),i=u[null!=(c=r.getFrom())?c:e];is_1.IsNon(i)?r.getIsOptional()?a[e]=null!=(M=a[e])?M:void 0:O(e,"VALUE","NOT AVAILABLE"):r.getIsArray()?n!==OMM_PROP_TYPES.MODEL?a[e]=Array.from(i).map(function(r){return _(e,n,r,o)}):a[e]=Array.from(i).map(function(r){return l(o,r)}):n!==OMM_PROP_TYPES.MODEL?a[e]=_(e,n,i,o):a[e]=l(o,i)}catch(r){throw error_omm_1.ErrorOMM.withPrev(nameModel(s)+"."+e,r)}}(o[t]);return a}function t(r,e){if(is_1.IsNon(e)||!is_1.IsObject(e)||Array.isArray(e))throw new error_omm_1.ErrorOMM("‘Data‘ expected ‘OBJECT‘ value but value is ‘"+e+"‘");return l(r,e)}function o(e,r){if(is_1.IsNon(r)||!is_1.IsArray(r))throw new error_omm_1.ErrorOMM("‘Data‘ expected ‘ARRAY‘ value but value is ‘"+r+"‘");return Array.from(r).map(function(r){return l(e,r)})}function u(r,e,t){try{if(!r||!e)throw new error_omm_1.ErrorOMM("Model or data is missing...");return t.call(null,r,e)}catch(r){e=error_omm_1.ErrorOMM.withPrev("Something went wrong...",r);throw e.printStack(),e}}return{injectModelPropOpt:function(r,e,t){var o;null!==(o=keyModel(r))&&void 0!==o&&o.includes(i(r))||s(r),t=ModelPropOption.new().setPropType(t.type).setIsOptional(null===t||void 0===t?void 0:t.optional).setIsArray(null===t||void 0===t?void 0:t.array).setFrom(null===t||void 0===t?void 0:t.from),n[keyModel(r)].setOnePropOption(e,t),function r(e,t){var o=t.__proto__;null!=o&&o.name&&""!==(null==o?void 0:o.name)&&(n[keyModel(o)].getOptionsKeys().forEach(function(r){n[e].setOnePropOption(r,n[keyModel(o)].getOptionByPropName(r))}),r(e,o))}(keyModel(r),r)},confirmModel:function(r){var e;try{null!==(e=keyModel(r))&&void 0!==e&&e.includes(i(r))||s(r),n[keyModel(r)].setIsConfirmed(!0)}catch(r){throw new error_omm_1.ErrorOMM("Something went wrong...")}},sinCoerce:function(r,e){return u(r,e,t)},multiCoerce:function(r,e){return u(r,e,o)}}}();function Model(r){try{storeInstance.confirmModel(r),Object.freeze(r)}catch(r){var e=error_omm_1.ErrorOMM.withPrev("Something went wrong...",r);throw e.printStack(),e}return r}function Prop(t,o){return function(r,e){try{storeInstance.injectModelPropOpt(r.constructor,String(e),__assign({type:t,array:!1},o))}catch(r){e=error_omm_1.ErrorOMM.withPrev("Something went wrong...",r);throw e.printStack(),e}}}function PropArr(t,o){return function(r,e){try{storeInstance.injectModelPropOpt(r.constructor,String(e),__assign({type:t,array:!0},o))}catch(r){e=error_omm_1.ErrorOMM.withPrev("Something went wrong...",r);throw e.printStack(),e}}}function sinCoerce(r,e){return storeInstance.sinCoerce(r,e)}function multiCoerce(r,e){return storeInstance.multiCoerce(r,e)}Object.freeze(storeInstance),exports.Model=Model,exports.Prop=Prop,exports.PropArr=PropArr,exports.sinCoerce=sinCoerce,exports.multiCoerce=multiCoerce,exports.MAPJC=Object.freeze({Model:Model,Prop:Prop,PropArr:PropArr,sinCoerce:sinCoerce,multiCoerce:multiCoerce});