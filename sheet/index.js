"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.Sheet=exports.SheetRow=void 0;var error_omm_1=require("./common/error.omm"),multi=/((?:^\s*)([\w#.@*,:\-.:>,*\s]+)\s*{(?:[\s]*)((?:[A-Za-z\- \s]+[:]\s*['"0-9\w .,\/()\-!%]+;?)*)*\s*}(?:\s*))/im,lineC="",Cell=function(){function e(){this.cell=""}return e.prototype.get=function(){return this.cell},e.new=function(){return new e},e.prototype.setCell=function(e){try{e||error_omm_1.ErrorOMM.withPrev("empty cell").throw(),e instanceof HTMLElement?this.cell=e.outerHTML:this.cell=e,(new DOMParser).parseFromString(this.cell.toString(),"text/html")}catch(e){error_omm_1.ErrorOMM.withPrev("Cell parse error").throw()}return this},e}();Object.freeze(Cell);var SheetRow=function(){function e(){this.cells=new Array}return e.prototype.get=function(){return this.cells},e.prototype.addCell=function(e){try{e||error_omm_1.ErrorOMM.withPrev("Inccorrect cell").throw();var t=Cell.new().setCell(e);this.cells.push(t)}catch(e){error_omm_1.ErrorOMM.withPrev("Style parse error").printStack().throw()}return this},e}();exports.SheetRow=SheetRow,Object.freeze(SheetRow);var tepmlate1='\n<html xmlns:x="urn:schemas-microsoft-com:office:excel">\n<head>\n    <meta charset="utf-8" />\n    <xml>\n        <x:ExcelWorkbook>\n            <x:ExcelWorksheets>\n                <x:ExcelWorksheet>\n                    <x:WorksheetOptions>\n                        <x:Panes>\n                        </x:Panes>\n                    </x:WorksheetOptions>\n                </x:ExcelWorksheet>\n            </x:ExcelWorksheets>\n        </x:ExcelWorkbook>\n    </xml>\n    {style}\n</head>\n<body>\n    <table  class="table">\n        <thead>\n            <tr>\n                {header}\n            </tr>\n        </thead>\n        <tbody>\n            {body}\n        </tbody>\n    </table>\n</body>\n</html>',tepmlate2='<html xmlns:o="urn:schemas-microsoft-com:office:office" xmlns:x="urn:schemas-microsoft-com:office:excel" xmlns="http://www.w3.org/TR/REC-html40"><head><xml><x:ExcelWorkbook><x:ExcelWorksheets><x:ExcelWorksheet><x:Name>Worksheet</x:Name><x:WorksheetOptions><x:DisplayGridlines/></x:WorksheetOptions></x:ExcelWorksheet></x:ExcelWorksheets></x:ExcelWorkbook></xml></head><body>{table}</body></html>',SheetBuilder=function(){function e(){this.sheetFile=""}return e.prototype.formHeader=function(e){return e.map(function(e){return"<th>"+e.get()+"</th>"}).join("")},e.prototype.formRows=function(e){return e.map(function(e){return"<tr>"+e.get().map(function(e){return"<td>"+e.get()+"</td>"}).join("")+"</tr>"}).join(lineC)},e.prototype.build_v1=function(e,t,r){return this.sheetFile=tepmlate1.replace(/\n/g,"").replace(/\{style\}/g,e.get()).replace(/\{header\}/g,this.formHeader(t)).replace(/\{body\}/g,this.formRows(r)),this},e.prototype.build_v3=function(e,t,r){var o="<table><thead><tr>{header}</tr></thead><tbody>{body}</tbody></table>".replace(/\n/g,"").replace(/\{style\}/g,e.get()).replace(/\{header\}/g,this.formHeader(t)).replace(/\{body\}/g,this.formRows(r)).replace(/ /g,"\n");return this.sheetFile=tepmlate2.replace(/\n/g,"").replace(/\{table\}/g,o),this},e.prototype.build_vTable=function(e){return this.sheetFile=tepmlate2.replace(/\n/g,"").replace(/\{table\}/g,e.outerHTML),this},e.prototype.download=function(){var e=this;return function(){try{var t="data:application/vnd.ms-excel;charset=utf-8, "+unescape(encodeURIComponent(e.sheetFile)),r=(new Date).toISOString()+".xlsx",o=document.createElement("a");o.setAttribute("href",t),o.setAttribute("download",r),o.click()}catch(e){error_omm_1.ErrorOMM.withPrev("Download error").printStack().throw()}}},e}();Object.freeze(SheetBuilder);var Sheet=function(){function e(){this.extStyle=new Cell,this.headers=[],this.rows=[]}return e.prototype.setStyle=function(e){try{e||error_omm_1.ErrorOMM.withPrev("Inccorrect style").throw();var t=Cell.new().setCell(e);multi.test(t.get())||error_omm_1.ErrorOMM.withPrev("Style pattern is inccorect").throw(),this.extStyle=t}catch(e){error_omm_1.ErrorOMM.withPrev("Style parse error").printStack().throw()}return this},e.prototype.addColumn=function(e){try{var t=Cell.new().setCell(e);this.headers.push(t)}catch(e){error_omm_1.ErrorOMM.withPrev("Colum parse error").printStack().throw()}return this},e.prototype.addRow=function(e){return this.rows.push(e),this},e.prototype.compile=function(){try{var e=new SheetBuilder;return e.build_v3(this.extStyle,this.headers,this.rows),{download:e.download()}}catch(e){error_omm_1.ErrorOMM.withPrev("Compile error").printStack().throw()}return{}},e.prototype.compileWithTable=function(e){try{"table"!==e.tagName&&error_omm_1.ErrorOMM.withPrev("Incorrect element").printStack().throw();var t=new SheetBuilder;return t.build_vTable(e),{download:t.download()}}catch(e){error_omm_1.ErrorOMM.withPrev("Compile error").printStack().throw()}return{}},e}();exports.Sheet=Sheet,Object.freeze(Sheet);